<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë˜‘í‰</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #0f0f0f;
            min-height: 100vh;
            padding: 20px;
            color: #e0e0e0;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: #1a1a1a;
            border-radius: 15px;
            box-shadow: 0 15px 30px rgba(0,0,0,0.3);
            overflow: hidden;
            border: 1px solid #333;
        }

        .header {
            background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .header p {
            opacity: 0.9;
            font-size: 1.1em;
        }

        .main-content {
            display: flex;
            min-height: 600px;
        }

        .upload-panel {
            width: 25%;
            padding: 40px;
            border-right: 1px solid #333;
            background: #1f1f1f;
        }

        .html-panel {
            width: 75%;
            padding: 40px;
            display: none;
            background: #1a1a1a;
        }

        .upload-area {
            border: 3px dashed #444;
            border-radius: 10px;
            padding: 60px 20px;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
            background: #262626;
        }

        .upload-area:hover {
            border-color: #2563eb;
            background-color: #2a2a2a;
        }

        .upload-area.dragover {
            border-color: #2563eb;
            background-color: #2e2e2e;
        }

        .upload-icon {
            font-size: 3em;
            color: #666;
            margin-bottom: 20px;
        }

        .upload-text {
            font-size: 1.1em;
            color: #b0b0b0;
            margin-bottom: 15px;
        }

        .file-input {
            display: none;
        }

        .upload-btn {
            background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            font-size: 1em;
            cursor: pointer;
            transition: transform 0.2s ease;
        }

        .upload-btn:hover {
            transform: translateY(-2px);
            background: linear-gradient(135deg, #1d4ed8 0%, #1e40af 100%);
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .spinner {
            border: 4px solid #333;
            border-top: 4px solid #2563eb;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .file-info {
            background: #1e3a2e;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #10b981;
            border: 1px solid #374151;
        }

        .file-info h4 {
            color: #10b981;
            margin-bottom: 8px;
        }

        .file-info p {
            color: #d1fae5;
            margin: 3px 0;
            font-size: 14px;
        }

        .html-content {
            background: #1f1f1f;
            border: 1px solid #333;
            border-radius: 8px;
            padding: 20px;
            min-height: 500px;
            overflow-y: auto;
            max-height: 80vh;
            color: #e0e0e0;
        }

        /* ë¬¸ì„œ HTML ìŠ¤íƒ€ì¼ë§ */
        .html-content table {
            width: 100%;
            border-collapse: collapse;
            margin: 10px 0;
        }

        .html-content table td {
            border: 1px solid #444;
            padding: 8px;
            vertical-align: top;
            background: #262626;
        }

        .html-content header {
            font-weight: bold;
            margin: 10px 0;
            color: #e0e0e0;
        }

        .html-content h1 {
            font-size: 18px;
            margin: 15px 0;
            text-align: center;
            color: #fff;
        }

        .html-content figure img {
            max-width: 300px;
            height: auto;
            border: 1px solid #444;
            border-radius: 4px;
            margin: 10px 0;
        }

        .html-content p {
            margin: 8px 0;
            line-height: 1.5;
        }

        .html-content img {
            max-width: 100%;
            height: auto;
            display: block;
            margin: 10px auto;
        }

        .error {
            background: #3a1f1f;
            border: 1px solid #ef4444;
            color: #fca5a5;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
        }

        .success {
            background: #1e3a2e;
            border: 1px solid #10b981;
            color: #86efac;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
        }

        .reset-btn {
            background: #4b5563;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            margin-top: 20px;
            transition: background 0.2s ease;
        }

        .reset-btn:hover {
            background: #374151;
        }

        @media (max-width: 1024px) {
            .main-content {
                flex-direction: column;
            }
            
            .upload-panel, .html-panel {
                width: 100%;
            }
            
            .upload-panel {
                border-right: none;
                border-bottom: 1px solid #eee;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ“ ë˜‘í‰</h1>
            <p>í‰ê°€í‘œë¥¼ ìŠ¤ë§ˆíŠ¸í•˜ê²Œ ìƒì„±í•˜ê³  ê´€ë¦¬í•˜ì„¸ìš”</p>
        </div>

        <div class="main-content">
            <div class="upload-panel">
                <div class="upload-area" id="uploadArea">
                    <div class="upload-icon">ğŸ“</div>
                    <div class="upload-text">HWP ë˜ëŠ” PDF íŒŒì¼ì„ ì—¬ê¸°ë¡œ ë“œë˜ê·¸í•˜ê±°ë‚˜ í´ë¦­í•˜ì—¬ ì„ íƒí•˜ì„¸ìš”</div>
                    <button class="upload-btn" id="selectFileBtn">íŒŒì¼ ì„ íƒ</button>
                    <input type="file" id="fileInput" class="file-input" accept=".hwp,.pdf">
                </div>

                <div class="loading" id="loading">
                    <div class="spinner"></div>
                    <p>ğŸ” Document Digitization APIë¡œ ë¶„ì„ ì¤‘...</p>
                </div>
            </div>

            <div class="html-panel" id="htmlPanel">
                <div class="file-info" id="fileInfo" style="display: none;"></div>
                
                <h3>ğŸ“ ë˜‘í‰ ë³€í™˜í•˜ê¸°</h3>
                <div class="html-content" id="htmlContent"></div>

                <button class="reset-btn" onclick="resetViewer()">ë‹¤ë¥¸ íŒŒì¼ ë¶„ì„</button>
            </div>
        </div>
    </div>

    <script>
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const selectFileBtn = document.getElementById('selectFileBtn');
        const loading = document.getElementById('loading');
        const htmlPanel = document.getElementById('htmlPanel');
        const uploadPanel = document.querySelector('.upload-panel');

        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
        selectFileBtn.addEventListener('click', () => fileInput.click());
        uploadArea.addEventListener('click', () => fileInput.click());
        fileInput.addEventListener('change', handleFileSelect);

        // ë“œë˜ê·¸ ì•¤ ë“œë¡­
        uploadArea.addEventListener('dragover', handleDragOver);
        uploadArea.addEventListener('dragleave', handleDragLeave);
        uploadArea.addEventListener('drop', handleDrop);

        function handleDragOver(e) {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        }

        function handleDragLeave(e) {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
        }

        function handleDrop(e) {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFile(files[0]);
            }
        }

        function handleFileSelect(e) {
            const file = e.target.files[0];
            if (file) {
                handleFile(file);
            }
        }

        function handleFile(file) {
            const fileName = file.name.toLowerCase();
            if (!fileName.endsWith('.hwp') && !fileName.endsWith('.pdf')) {
                showError('HWP ë˜ëŠ” PDF íŒŒì¼ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤.');
                return;
            }

            if (file.size > 16 * 1024 * 1024) {
                showError('íŒŒì¼ í¬ê¸°ëŠ” 16MBë¥¼ ì´ˆê³¼í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            uploadFile(file);
        }

        function uploadFile(file) {
            const formData = new FormData();
            formData.append('file', file);

            loading.style.display = 'block';
            uploadArea.style.display = 'none';

            fetch('/api/analyze-document', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                loading.style.display = 'none';
                
                if (data.success) {
                    showHTMLContent(data);
                } else {
                    showError(data.error || 'API ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                    uploadArea.style.display = 'block';
                }
            })
            .catch(error => {
                loading.style.display = 'none';
                showError('ì„œë²„ ì—°ê²° ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                uploadArea.style.display = 'block';
                console.error('Error:', error);
            });
        }

        function showHTMLContent(data) {
            // íŒŒì¼ ì •ë³´ í‘œì‹œ (íŒŒì¼ëª…ë§Œ)
            const fileInfo = document.getElementById('fileInfo');
            fileInfo.innerHTML = `
                <p><strong>ğŸ“„ ${data.original_filename}</strong></p>
            `;
            fileInfo.style.display = 'block';

            // HTML ë‚´ìš© í‘œì‹œ
            const htmlContent = document.getElementById('htmlContent');
            if (data.html_content) {
        htmlContent.innerHTML = data.html_content;

        // ì—¬ê¸°ì„œ ë²„íŠ¼ ì‚½ì… ì‘ì—…!
        setTimeout(() => {
            const allTables = htmlContent.querySelectorAll('table');
            
            allTables.forEach((table, tableIndex) => {
                const rows = table.querySelectorAll('tr');
                let contextInfo = {
                    grade: '',
                    semester: '',
                    subject: '',
                    unit: '',
                    criteria: '',
                    domain: ''
                };

                // ì»¨í…ìŠ¤íŠ¸ ì •ë³´ ìˆ˜ì§‘
                rows.forEach(row => {
                    const firstCell = row.children[0]?.innerText?.trim();
                    const secondCell = row.children[1]?.innerText?.trim();
                    
                    if (firstCell === 'ë‹¨ì›ëª…') {
                        contextInfo.unit = secondCell;
                    } else if (firstCell === 'ì„±ì·¨ê¸°ì¤€') {
                        contextInfo.criteria = secondCell;
                    } else if (firstCell === 'ì˜ ì—­' || firstCell === 'ì˜ì—­') {
                        contextInfo.domain = secondCell;
                    }
                });

                // í•™ë…„/í•™ê¸° ì •ë³´ ìˆ˜ì§‘ (í‘œ ìœ„ì˜ í…ìŠ¤íŠ¸ì—ì„œ)
                const prevElements = [];
                let currentElement = table.previousElementSibling;
                for (let i = 0; i < 5 && currentElement; i++) {
                    prevElements.unshift(currentElement.innerText?.trim() || '');
                    currentElement = currentElement.previousElementSibling;
                }
                
                // ê³¼ëª©ëª…ê³¼ í•™ë…„/í•™ê¸° ì •ë³´ ì°¾ê¸°
                prevElements.forEach(text => {
                    if (text.includes('í•™ë…„') && text.includes('í•™ê¸°')) {
                        const gradeMatch = text.match(/(\d+)í•™ë…„/);
                        const semesterMatch = text.match(/(\d+)í•™ê¸°/);
                        if (gradeMatch) contextInfo.grade = gradeMatch[1];
                        if (semesterMatch) contextInfo.semester = semesterMatch[1];
                    }
                    if (text.includes('ê³¼') && text.includes('í‰ê°€')) {
                        contextInfo.subject = text.replace('í‰ê°€ ê¸°ì¤€ì•ˆ', '').trim();
                    }
                });

                // í‰ê°€ìš”ì†Œ ì°¾ì•„ì„œ ë²„íŠ¼ ì¶”ê°€
                rows.forEach(row => {
                    const firstCellText = row.children[0]?.innerText?.trim();
                    if (firstCellText === 'í‰ê°€ìš”ì†Œ') {
                        const targetTd = row.children[1];
                        const original = targetTd.innerHTML;

                        // ì´ë¯¸ ë²„íŠ¼ì´ ìˆëŠ”ì§€ í™•ì¸
                        if (targetTd.querySelector('button')) {
                            return;
                        }

                        const button = document.createElement('button');
                        button.innerText = 'ìƒˆë¡œìš´ ë¬¸ì¥ ìƒì„±';
                        button.onclick = () => generateTextOptionsAndCriteria(targetTd, contextInfo, table);
                        button.style.marginLeft = '10px';
                        button.style.padding = '4px 8px';
                        button.style.fontSize = '12px';
                        button.style.backgroundColor = '#007bff';
                        button.style.color = 'white';
                        button.style.border = 'none';
                        button.style.borderRadius = '4px';
                        button.style.cursor = 'pointer';

                        // ë³µì‚¬ ë²„íŠ¼ ìƒì„±
                        const copyButton = document.createElement('button');
                        copyButton.innerText = 'ğŸ“‹ ë³µì‚¬';
                        copyButton.onclick = () => copyTextToClipboard(targetTd);
                        copyButton.style.marginLeft = '5px';
                        copyButton.style.padding = '4px 8px';
                        copyButton.style.fontSize = '12px';
                        copyButton.style.backgroundColor = '#28a745';
                        copyButton.style.color = 'white';
                        copyButton.style.border = 'none';
                        copyButton.style.borderRadius = '4px';
                        copyButton.style.cursor = 'pointer';

                        // ë²„íŠ¼ ì‚½ì…
                        targetTd.innerHTML = `<span class="original-text">${original}</span>`;
                        targetTd.appendChild(button);
                        targetTd.appendChild(copyButton);
                    }
                });

                // í‰ê°€ê¸°ì¤€ í…Œì´ë¸”ì—ë„ ë²„íŠ¼ ì¶”ê°€
                addCriteriaButtons(table, contextInfo);
            });
        }, 10); // DOMì´ ê·¸ë ¤ì§€ê³  ë‚˜ì„œ ì‚½ì…ë˜ë„ë¡ delay
    } else {
                htmlContent.innerHTML = '<p>ë³€í™˜ëœ HTML ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
                showMessage('HTML ë‚´ìš©ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'error');
            }

            // HTML íŒ¨ë„ í‘œì‹œ
            uploadPanel.style.width = '20%';
            htmlPanel.style.display = 'block';

            // ë””ë²„ê¹…ìš©: ì „ì²´ API ì‘ë‹µì„ ì½˜ì†”ì— ì¶œë ¥
            console.log('Full API Response:', data.full_api_response);
        }

        function resetViewer() {
            document.getElementById('fileInput').value = '';
            uploadArea.style.display = 'block';
            htmlPanel.style.display = 'none';
            uploadPanel.style.width = '25%';
            
            // ê¸°ì¡´ ë©”ì‹œì§€ ì œê±°
            const existingMessages = document.querySelectorAll('.error, .success');
            existingMessages.forEach(msg => msg.remove());
        }

        function showError(message) {
            showMessage(message, 'error');
        }

        function showMessage(message, type) {
            const existingMessage = document.querySelector('.error, .success');
            if (existingMessage) {
                existingMessage.remove();
            }

            const messageDiv = document.createElement('div');
            messageDiv.className = type;
            messageDiv.textContent = message;
            
            const container = htmlPanel.style.display === 'block' ? htmlPanel : uploadPanel;
            container.insertBefore(messageDiv, container.firstChild);

            setTimeout(() => {
                if (messageDiv.parentNode) {
                    messageDiv.remove();
                }
            }, 5000);
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
    </script>
</body>
</html>

<script>
    async function generateTextOptions(tdElement, contextInfo) {
        const span = tdElement.querySelector('.original-text');
        const originalText = span.innerText.trim();

        // ê¸°ì¡´ ì•„ì½”ë””ì–¸ì´ ìˆìœ¼ë©´ ì œê±°
        const existingAccordion = tdElement.querySelector('.text-options-accordion');
        if (existingAccordion) {
            existingAccordion.remove();
        }

        // ë¡œë”© í‘œì‹œ
        span.innerText = 'â³ ë¬¸ì¥ ìƒì„± ì¤‘...';

        try {
            const res = await fetch('/api/generate-text-options', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ 
                    text: originalText,
                    context: contextInfo
                })
            });

            const result = await res.json();

            if (result.success) {
                // ì›ë¬¸ ë³µêµ¬
                span.innerText = originalText;
                
                // ì•„ì½”ë””ì–¸ UI ìƒì„±
                createTextOptionsAccordion(tdElement, result.options, originalText);
            } else {
                span.innerText = originalText;
                alert('âŒ ì˜¤ë¥˜: ' + result.error);
            }
        } catch (err) {
            console.error(err);
            span.innerText = originalText;
            alert('ì„œë²„ ì—°ê²° ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
    }

    function createTextOptionsAccordion(tdElement, options, originalText) {
        const accordion = document.createElement('div');
        accordion.className = 'text-options-accordion';
        accordion.style.cssText = `
            margin-top: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background: #f8f9fa;
            max-width: 500px;
        `;

        const header = document.createElement('div');
        header.innerHTML = 'ğŸ“ ìƒì„±ëœ ë¬¸ì¥ ì˜µì…˜ (í´ë¦­í•˜ì—¬ ì„ íƒ)';
        header.style.cssText = `
            padding: 8px 12px;
            background: #e9ecef;
            border-bottom: 1px solid #ddd;
            font-weight: bold;
            font-size: 13px;
            cursor: pointer;
        `;

        const content = document.createElement('div');
        content.style.cssText = `
            padding: 8px;
            display: block;
        `;

        // ì›ë¬¸ ì˜µì…˜ ì¶”ê°€
        const originalOption = document.createElement('div');
        originalOption.className = 'text-option';
        originalOption.innerHTML = `
            <div style="padding: 8px; border: 1px solid #ccc; margin-bottom: 5px; cursor: pointer; border-radius: 3px; background: #fff;">
                <strong>ì›ë¬¸:</strong> ${originalText}
            </div>
        `;
        originalOption.onclick = () => selectOption(tdElement, originalText);
        content.appendChild(originalOption);

        // ìƒì„±ëœ ì˜µì…˜ë“¤ ì¶”ê°€
        options.forEach((option, index) => {
            const optionDiv = document.createElement('div');
            optionDiv.className = 'text-option';
            optionDiv.innerHTML = `
                <div style="padding: 8px; border: 1px solid #007bff; margin-bottom: 5px; cursor: pointer; border-radius: 3px; background: #fff; transition: background-color 0.2s;">
                    <strong>ì˜µì…˜ ${index + 1}:</strong> ${option}
                </div>
            `;
            optionDiv.onmouseover = () => optionDiv.firstElementChild.style.backgroundColor = '#e3f2fd';
            optionDiv.onmouseout = () => optionDiv.firstElementChild.style.backgroundColor = '#fff';
            optionDiv.onclick = () => selectOption(tdElement, option);
            content.appendChild(optionDiv);
        });

        // ë‹«ê¸° ë²„íŠ¼
        const closeBtn = document.createElement('button');
        closeBtn.innerText = 'âœ• ë‹«ê¸°';
        closeBtn.style.cssText = `
            margin-top: 8px;
            padding: 4px 8px;
            background: #6c757d;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 11px;
        `;
        closeBtn.onclick = () => accordion.remove();
        content.appendChild(closeBtn);

        accordion.appendChild(header);
        accordion.appendChild(content);
        tdElement.appendChild(accordion);
    }

    function selectOption(tdElement, selectedText) {
        const span = tdElement.querySelector('.original-text');
        const originalText = span.innerText.trim();
        span.innerText = selectedText;
        
        // ì•„ì½”ë””ì–¸ ì œê±°
        const accordion = tdElement.querySelector('.text-options-accordion');
        if (accordion) {
            accordion.remove();
        }
        
        // ì„ íƒ ì™„ë£Œ ì•Œë¦¼ (ì ê¹ë§Œ í‘œì‹œ)
        const notification = document.createElement('span');
        notification.innerText = ' âœ…';
        notification.style.color = '#28a745';
        span.appendChild(notification);
        setTimeout(() => notification.remove(), 1500);
        
        // í‰ê°€ìš”ì†Œê°€ ë³€ê²½ëœ ê²½ìš°ì—ë§Œ í‰ê°€ê¸°ì¤€ ì—…ë°ì´íŠ¸ ì œì•ˆ
        if (selectedText !== originalText) {
            // í˜„ì¬ í…Œì´ë¸” ì°¾ê¸°
            const table = tdElement.closest('table');
            if (table) {
                // ì»¨í…ìŠ¤íŠ¸ ì •ë³´ ìˆ˜ì§‘
                const contextInfo = extractContextFromTable(table);
                
                // í‰ê°€ê¸°ì¤€ ì—…ë°ì´íŠ¸ ì œì•ˆ
                setTimeout(() => {
                    const shouldUpdate = confirm("í‰ê°€ìš”ì†Œê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤. í‰ê°€ê¸°ì¤€(ë§¤ìš°ì˜í•¨, ì˜í•¨, ë³´í†µ, ë…¸ë ¥ìš”í•¨)ë„ í•¨ê»˜ ì—…ë°ì´íŠ¸í•˜ì‹œê² ìŠµë‹ˆê¹Œ?");
                    if (shouldUpdate) {
                        generateEvaluationCriteria(table, selectedText, contextInfo);
                    }
                }, 500); // ì²´í¬ë§ˆí¬ í‘œì‹œ í›„ ì•½ê°„ì˜ ë”œë ˆì´
            }
        }
    }

    function copyTextToClipboard(tdElement) {
        const span = tdElement.querySelector('.original-text');
        const text = span.innerText.trim();
        
        // í´ë¦½ë³´ë“œ APIê°€ ìˆëŠ”ì§€ í™•ì¸
        if (navigator.clipboard && window.isSecureContext) {
            navigator.clipboard.writeText(text).then(() => {
                alert("ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!");
            }).catch((err) => {
                console.error('í´ë¦½ë³´ë“œ ë³µì‚¬ ì‹¤íŒ¨:', err);
                // fallback ë°©ë²• ì‚¬ìš©
                fallbackCopy(text);
            });
        } else {
            // fallback ë°©ë²• ì‚¬ìš©
            fallbackCopy(text);
        }
    }

    function fallbackCopy(text) {
        // ì„ì‹œ textarea ìƒì„±
        const textArea = document.createElement('textarea');
        textArea.value = text;
        textArea.style.position = 'fixed';
        textArea.style.left = '-999999px';
        textArea.style.top = '-999999px';
        document.body.appendChild(textArea);
        
        textArea.focus();
        textArea.select();
        
        try {
            const successful = document.execCommand('copy');
            if (successful) {
                alert("ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!");
            } else {
                alert("ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
            }
        } catch (err) {
            console.error('ë³µì‚¬ ì‹¤íŒ¨:', err);
            alert("ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: " + err);
        } finally {
            document.body.removeChild(textArea);
        }
    }

    async function generateTextOptionsAndCriteria(tdElement, contextInfo, table) {
        // ê¸°ì¡´ í‰ê°€ìš”ì†Œ ìƒì„± í•¨ìˆ˜ í˜¸ì¶œ (ì•„ì½”ë””ì–¸ì—ì„œ ì„ íƒ ì‹œ ìë™ìœ¼ë¡œ í‰ê°€ê¸°ì¤€ ì—…ë°ì´íŠ¸ ë¨)
        await generateTextOptions(tdElement, contextInfo);
    }

    function addCriteriaButtons(table, contextInfo) {
        const rows = table.querySelectorAll('tr');
        const criteriaLevels = ['ë§¤ìš°ì˜í•¨', 'ì˜í•¨', 'ë³´í†µ', 'ë…¸ë ¥ìš”í•¨'];
        
        rows.forEach(row => {
            const firstCellText = row.children[0]?.innerText?.trim();
            if (criteriaLevels.includes(firstCellText)) {
                const targetTd = row.children[1];
                
                // ì´ë¯¸ ë²„íŠ¼ì´ ìˆëŠ”ì§€ í™•ì¸
                if (targetTd.querySelector('button')) {
                    return;
                }
                
                const original = targetTd.innerHTML;
                
                const button = document.createElement('button');
                button.innerText = 'ğŸ”„';
                button.onclick = () => generateSingleCriteria(targetTd, firstCellText, contextInfo, table);
                button.style.marginLeft = '10px';
                button.style.padding = '3px 6px';
                button.style.fontSize = '11px';
                button.style.backgroundColor = '#6f42c1';
                button.style.color = 'white';
                button.style.border = 'none';
                button.style.borderRadius = '3px';
                button.style.cursor = 'pointer';

                // ë³µì‚¬ ë²„íŠ¼
                const copyButton = document.createElement('button');
                copyButton.innerText = 'ğŸ“‹';
                copyButton.onclick = () => copyTextToClipboard(targetTd);
                copyButton.style.marginLeft = '3px';
                copyButton.style.padding = '3px 6px';
                copyButton.style.fontSize = '11px';
                copyButton.style.backgroundColor = '#28a745';
                copyButton.style.color = 'white';
                copyButton.style.border = 'none';
                copyButton.style.borderRadius = '3px';
                copyButton.style.cursor = 'pointer';

                targetTd.innerHTML = `<span class="original-text">${original}</span>`;
                targetTd.appendChild(button);
                targetTd.appendChild(copyButton);
            }
        });
    }

    async function generateEvaluationCriteria(table, evaluationElement, contextInfo) {
        const rows = table.querySelectorAll('tr');
        const criteriaLevels = ['ë§¤ìš°ì˜í•¨', 'ì˜í•¨', 'ë³´í†µ', 'ë…¸ë ¥ìš”í•¨'];
        
        // ê¸°ì¡´ í‰ê°€ê¸°ì¤€ í…ìŠ¤íŠ¸ ìˆ˜ì§‘
        const originalCriteria = {};
        rows.forEach(row => {
            const firstCellText = row.children[0]?.innerText?.trim();
            if (criteriaLevels.includes(firstCellText)) {
                const targetTd = row.children[1];
                const span = targetTd.querySelector('.original-text');
                originalCriteria[firstCellText] = span ? span.innerText.trim() : '';
            }
        });

        try {
            const res = await fetch('/api/generate-evaluation-criteria', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ 
                    evaluationElement: evaluationElement,
                    originalCriteria: originalCriteria,
                    context: contextInfo
                })
            });

            const result = await res.json();

            if (result.success) {
                // ìƒì„±ëœ í‰ê°€ê¸°ì¤€ ì ìš©
                rows.forEach(row => {
                    const firstCellText = row.children[0]?.innerText?.trim();
                    if (criteriaLevels.includes(firstCellText) && result.criteria[firstCellText]) {
                        const targetTd = row.children[1];
                        const span = targetTd.querySelector('.original-text');
                        if (span) {
                            span.innerText = result.criteria[firstCellText];
                            
                            // ì—…ë°ì´íŠ¸ ì•Œë¦¼
                            const notification = document.createElement('span');
                            notification.innerText = ' âœ¨ ì—…ë°ì´íŠ¸ë¨';
                            notification.style.color = '#007bff';
                            notification.style.fontSize = '10px';
                            span.appendChild(notification);
                            setTimeout(() => notification.remove(), 2000);
                        }
                    }
                });
            } else {
                alert('âŒ í‰ê°€ê¸°ì¤€ ìƒì„± ì˜¤ë¥˜: ' + result.error);
            }
        } catch (err) {
            console.error(err);
            alert('í‰ê°€ê¸°ì¤€ ìƒì„± ì¤‘ ì„œë²„ ì—°ê²° ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
    }

    async function generateSingleCriteria(tdElement, level, contextInfo, table) {
        const span = tdElement.querySelector('.original-text');
        const originalText = span.innerText.trim();
        
        // í˜„ì¬ í…Œì´ë¸”ì˜ í‰ê°€ìš”ì†Œ ì°¾ê¸°
        const evaluationElement = findEvaluationElementInTable(table);
        
        span.innerText = 'â³ ê¸°ì¤€ ìƒì„± ì¤‘...';

        try {
            const res = await fetch('/api/generate-single-criteria', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ 
                    level: level,
                    evaluationElement: evaluationElement,
                    originalText: originalText,
                    context: contextInfo
                })
            });

            const result = await res.json();

            if (result.success) {
                span.innerText = result.criteria;
            } else {
                span.innerText = originalText;
                alert('âŒ ì˜¤ë¥˜: ' + result.error);
            }
        } catch (err) {
            console.error(err);
            span.innerText = originalText;
            alert('ì„œë²„ ì—°ê²° ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
    }

    function findEvaluationElementInTable(table) {
        const rows = table.querySelectorAll('tr');
        for (const row of rows) {
            const firstCellText = row.children[0]?.innerText?.trim();
            if (firstCellText === 'í‰ê°€ìš”ì†Œ') {
                const span = row.children[1]?.querySelector('.original-text');
                return span ? span.innerText.trim() : '';
            }
        }
        return '';
    }

    function extractContextFromTable(table) {
        const rows = table.querySelectorAll('tr');
        let contextInfo = {
            grade: '',
            semester: '',
            subject: '',
            unit: '',
            criteria: '',
            domain: ''
        };

        // í…Œì´ë¸” ë‚´ ì •ë³´ ìˆ˜ì§‘
        rows.forEach(row => {
            const firstCell = row.children[0]?.innerText?.trim();
            const secondCell = row.children[1]?.innerText?.trim();
            
            if (firstCell === 'ë‹¨ì›ëª…') {
                contextInfo.unit = secondCell;
            } else if (firstCell === 'ì„±ì·¨ê¸°ì¤€') {
                contextInfo.criteria = secondCell;
            } else if (firstCell === 'ì˜ ì—­' || firstCell === 'ì˜ì—­') {
                contextInfo.domain = secondCell;
            }
        });

        // í•™ë…„/í•™ê¸° ì •ë³´ ìˆ˜ì§‘ (í‘œ ìœ„ì˜ í…ìŠ¤íŠ¸ì—ì„œ)
        const prevElements = [];
        let currentElement = table.previousElementSibling;
        for (let i = 0; i < 5 && currentElement; i++) {
            prevElements.unshift(currentElement.innerText?.trim() || '');
            currentElement = currentElement.previousElementSibling;
        }
        
        // ê³¼ëª©ëª…ê³¼ í•™ë…„/í•™ê¸° ì •ë³´ ì°¾ê¸°
        prevElements.forEach(text => {
            if (text.includes('í•™ë…„') && text.includes('í•™ê¸°')) {
                const gradeMatch = text.match(/(\d+)í•™ë…„/);
                const semesterMatch = text.match(/(\d+)í•™ê¸°/);
                if (gradeMatch) contextInfo.grade = gradeMatch[1];
                if (semesterMatch) contextInfo.semester = semesterMatch[1];
            }
            if (text.includes('ê³¼') && text.includes('í‰ê°€')) {
                contextInfo.subject = text.replace('í‰ê°€ ê¸°ì¤€ì•ˆ', '').trim();
            }
        });

        return contextInfo;
    }

    async function improveTextWithContext(tdElement, contextInfo) {
        const span = tdElement.querySelector('.original-text');
        const originalText = span.innerText.trim();

        // ë¡œë”© í‘œì‹œ
        span.innerText = 'â³ ë¬¸ì¥ ìƒì„± ì¤‘...';

        try {
            const res = await fetch('/api/improve-text', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ 
                    text: originalText,
                    context: contextInfo
                })
            });

            const result = await res.json();

            if (result.success) {
                span.innerText = result.improved;
            } else {
                span.innerText = originalText;
                alert('âŒ ì˜¤ë¥˜: ' + result.error);
            }
        } catch (err) {
            console.error(err);
            span.innerText = originalText;
            alert('ì„œë²„ ì—°ê²° ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
    }

    // ê¸°ì¡´ í•¨ìˆ˜ (í˜¸í™˜ì„± ìœ ì§€)
    async function improveText(tdElement) {
        const span = tdElement.querySelector('.original-text');
        const originalText = span.innerText.trim();

        // ë¡œë”© í‘œì‹œ
        span.innerText = 'â³ ë¬¸ì¥ ìƒì„± ì¤‘...';

        try {
            const res = await fetch('/api/improve-text', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ text: originalText })
            });

            const result = await res.json();

            if (result.success) {
                span.innerText = result.improved;
            } else {
                span.innerText = originalText;
                alert('âŒ ì˜¤ë¥˜: ' + result.error);
            }
        } catch (err) {
            console.error(err);
            span.innerText = originalText;
            alert('ì„œë²„ ì—°ê²° ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
    }
</script>